---
phase: 04-pr-review-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hypergraph/nodes/graph_node.py
  - src/hypergraph/_typing.py
  - src/hypergraph/graph.py
  - tests/test_graph.py
autonomous: true

must_haves:
  truths:
    - "GraphNode.get_input_type() returns inner graph's input types"
    - "GraphNode.is_async returns boolean, not method"
    - "Type compatibility rejects mismatched tuple arity"
    - "All Ruff lint checks pass"
  artifacts:
    - path: "src/hypergraph/nodes/graph_node.py"
      provides: "get_input_type override, is_async fix"
    - path: "src/hypergraph/_typing.py"
      provides: "strict zip for tuple arity checking"
    - path: "src/hypergraph/graph.py"
      provides: "updated docstring"
    - path: "tests/test_graph.py"
      provides: "lint-clean test helpers"
  key_links:
    - from: "GraphNode.get_input_type"
      to: "inner graph input annotations"
      via: "delegation to inner graph's input nodes"
---

<objective>
Fix Python code issues from PR #3 review comments (Codex P1/P2, CodeRabbit Major/Minor).

Purpose: Address all reviewer feedback on Python files before merging
Output: Clean code passing all tests and lint checks
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v1.0-ROADMAP.md

Source files:
@src/hypergraph/nodes/graph_node.py
@src/hypergraph/nodes/base.py
@src/hypergraph/_typing.py
@src/hypergraph/graph.py
@tests/test_graph.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix GraphNode.is_async returning bound method instead of boolean</name>
  <files>src/hypergraph/nodes/graph_node.py</files>
  <action>
    Line 91 returns `self._graph.has_async_nodes` (bound method) instead of calling it.

    Change:
    ```python
    return self._graph.has_async_nodes
    ```
    To:
    ```python
    return self._graph.has_async_nodes()
    ```

    This is a CodeRabbit Major issue - is_async was returning truthy method object instead of actual boolean.
  </action>
  <verify>
    ```bash
    uv run python -c "
    from hypergraph import Graph, node
    @node(output_name='x')
    async def async_fn(a: int) -> int: return a
    g = Graph([async_fn], name='test')
    gn = g.as_node()
    result = gn.is_async
    print(f'is_async type: {type(result)}, value: {result}')
    assert isinstance(result, bool), f'Expected bool, got {type(result)}'
    print('PASS: is_async returns boolean')
    "
    ```
  </verify>
  <done>GraphNode.is_async returns boolean True/False, not a method object</done>
</task>

<task type="auto">
  <name>Task 2: Add GraphNode.get_input_type to derive types from inner graph</name>
  <files>src/hypergraph/nodes/graph_node.py</files>
  <action>
    Codex P1: GraphNode doesn't override get_input_type, so base class returns None.
    This triggers "Missing type annotation" error for edges into GraphNode even when inner graph is typed.

    Add method after get_output_type (around line 141):

    ```python
    def get_input_type(self, param: str) -> type | None:
        """Get expected type for an input parameter from the inner graph.

        Derives the type from whichever node in the inner graph declares
        this parameter as an input.

        Args:
            param: Input parameter name

        Returns:
            The type annotation, or None if not annotated.
        """
        # Find which node in inner graph has this as an input
        for inner_node in self._graph._nodes.values():
            if param in inner_node.inputs:
                return inner_node.get_input_type(param)
        return None
    ```

    This delegates to the inner graph's nodes to find the input type.
  </action>
  <verify>
    ```bash
    uv run python -c "
    from hypergraph import Graph, node
    @node(output_name='x')
    def inner(a: int) -> str: return str(a)
    g = Graph([inner], name='test')
    gn = g.as_node()
    input_type = gn.get_input_type('a')
    print(f'Input type for a: {input_type}')
    assert input_type is int, f'Expected int, got {input_type}'
    print('PASS: get_input_type returns inner graph input types')
    "
    ```
  </verify>
  <done>GraphNode.get_input_type returns type annotations from inner graph's input nodes</done>
</task>

<task type="auto">
  <name>Task 3: Add strict=True to zip in generic type comparison</name>
  <files>src/hypergraph/_typing.py</files>
  <action>
    Codex P2: Line 384 uses `zip(incoming_args, required_args)` without checking lengths.
    This allows `tuple[int]` to be treated as compatible with `tuple[int, str]`.

    Change lines 382-385 from:
    ```python
    return all(
        is_type_compatible(t1, t2, memo)
        for t1, t2 in zip(incoming_args, required_args)
    )
    ```

    To:
    ```python
    # Require same arity for generic args
    if len(incoming_args) != len(required_args):
        return False

    return all(
        is_type_compatible(t1, t2, memo)
        for t1, t2 in zip(incoming_args, required_args, strict=True)
    )
    ```

    Note: We check length explicitly first, then use strict=True as extra safety.
    This rejects mismatched tuple arities like tuple[int] vs tuple[int, str].
  </action>
  <verify>
    ```bash
    uv run python -c "
    from hypergraph._typing import is_type_compatible
    # Same arity should work
    assert is_type_compatible(tuple[int, str], tuple[int, str]) == True
    # Mismatched arity should fail
    assert is_type_compatible(tuple[int], tuple[int, str]) == False
    assert is_type_compatible(tuple[int, str, float], tuple[int, str]) == False
    print('PASS: Generic arity checking works')
    "
    ```
  </verify>
  <done>Generic type comparison rejects mismatched argument counts</done>
</task>

<task type="auto">
  <name>Task 4: Update outdated docstring in graph.py strict_types property</name>
  <files>src/hypergraph/graph.py</files>
  <action>
    CodeRabbit Minor: Line 112 says "Type validation logic is implemented in a later phase"
    but _validate_types() is already implemented in this file.

    Change lines 108-114 from:
    ```python
    @property
    def strict_types(self) -> bool:
        """Whether type validation is enabled for this graph.

        When True, type compatibility between connected nodes will be validated.
        Type validation logic is implemented in a later phase.
        """
        return self._strict_types
    ```

    To:
    ```python
    @property
    def strict_types(self) -> bool:
        """Whether type validation is enabled for this graph.

        When True, type compatibility between connected nodes is validated
        at graph construction time via _validate_types().
        """
        return self._strict_types
    ```
  </action>
  <verify>
    ```bash
    uv run python -c "
    from hypergraph.graph import Graph
    docstring = Graph.strict_types.__doc__
    assert 'later phase' not in docstring, 'Outdated docstring not updated'
    assert '_validate_types' in docstring, 'Missing reference to implementation'
    print('PASS: Docstring updated')
    "
    ```
  </verify>
  <done>Docstring accurately describes current implementation</done>
</task>

<task type="auto">
  <name>Task 5: Fix Ruff ARG001 lint errors in test_graph.py</name>
  <files>tests/test_graph.py</files>
  <action>
    CodeRabbit Minor: Test helper functions have unused arguments triggering Ruff ARG001.
    Functions are only used for type signature testing, not actual computation.

    Prefix unused parameters with underscore in these test functions:
    - Line 873: `def inner_func(a: int)` -> `def inner_func(_a: int)`
    - Line 884: `def func_a(a: int)` -> `def func_a(_a: int)`
    - Line 888: `def func_b(x: str)` -> `def func_b(_x: str)`
    - Line 899: `def untyped(a)` -> `def untyped(_a)`
    - Line 910: `def typed(a: int)` -> `def typed(_a: int)`
    - Line 914: `def untyped(x)` -> `def untyped(_x)`
    - Line 926: `def inner(a: int)` -> `def inner(_a: int)`
    - Line 933: `def outer(x: str)` -> `def outer(_x: str)`
    - Line 1124: `def inner_func(a: int)` -> `def inner_func(_a: int)`
    - Line 1143: `def inner_func(a: int)` -> `def inner_func(_a: int)`

    Only modify the parameter names, keep return values unchanged (they may use literals).
  </action>
  <verify>
    ```bash
    uv run ruff check tests/test_graph.py --select ARG001 || echo "No ARG001 errors (good!)"
    ```
  </verify>
  <done>All Ruff ARG001 lint errors resolved in test_graph.py</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `uv run pytest tests/test_graph.py -v` - all graph tests pass
- [ ] `uv run pytest tests/test_typing.py -v` - all typing tests pass
- [ ] `uv run ruff check src/hypergraph/ tests/` - no lint errors
- [ ] `uv run pytest` - full test suite passes
</verification>

<success_criteria>
- All 5 tasks completed
- All tests pass (263+ tests)
- No Ruff lint errors
- GraphNode strict_types integration works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/04-pr-review-fixes/04-01-SUMMARY.md`
</output>
