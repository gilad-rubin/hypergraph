---
phase: 04-verification-testing
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - .github/workflows/viz-tests.yml
autonomous: true

must_haves:
  truths:
    - "CI runs edge routing tests on every push and PR"
    - "CI installs Playwright browsers automatically"
    - "Failed tests upload screenshots as artifacts"
  artifacts:
    - path: ".github/workflows/viz-tests.yml"
      provides: "GitHub Actions workflow for visualization tests"
      min_lines: 30
  key_links:
    - from: ".github/workflows/viz-tests.yml"
      to: "tests/viz/"
      via: "pytest command"
      pattern: "pytest tests/viz"
---

<objective>
Create GitHub Actions workflow to run visualization tests in CI.

Purpose: Catch edge routing regressions before they reach main branch.
Output: CI workflow that runs geometric and visual regression tests with artifact upload on failure.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-verification-testing/04-RESEARCH.md
@.planning/phases/04-verification-testing/04-01-PLAN.md

# Existing CI config for reference
@.github/workflows/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Check existing CI workflows</name>
  <files>None (read-only)</files>
  <action>
Check if .github/workflows/ exists and what workflows are already configured:

```bash
ls -la .github/workflows/ 2>/dev/null || echo "No workflows directory"
cat .github/workflows/*.yml 2>/dev/null | head -50 || echo "No existing workflows"
```

This determines whether to create a new workflow or integrate into existing one.
  </action>
  <verify>
Note what exists (if anything) for context in Task 2.
  </verify>
  <done>
Existing CI configuration understood.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create visualization tests workflow</name>
  <files>.github/workflows/viz-tests.yml</files>
  <action>
Create .github/workflows/viz-tests.yml:

```yaml
name: Visualization Tests

on:
  push:
    branches: [main, develop, fix-viz-*]
    paths:
      - 'src/hypergraph/viz/**'
      - 'tests/viz/**'
      - '.github/workflows/viz-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/hypergraph/viz/**'
      - 'tests/viz/**'

jobs:
  test:
    runs-on: ubuntu-22.04  # Pin version for consistent screenshots
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          uv sync --dev
          uv run playwright install --with-deps chromium

      - name: Run geometric verification tests
        run: |
          uv run pytest tests/viz/test_edge_routing.py -v --tb=short

      - name: Run visual regression tests
        run: |
          uv run pytest tests/viz/test_visual_regression.py -v --tb=short

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: viz-test-results
          path: |
            tests/viz/baselines/
            test-results/
          retention-days: 7
```

Key design decisions:
- Pin ubuntu-22.04 for consistent screenshot rendering
- Only run on viz-related file changes (paths filter)
- Separate steps for geometric vs visual tests (clear failure attribution)
- Upload baselines on failure for debugging
  </action>
  <verify>
`cat .github/workflows/viz-tests.yml` shows valid YAML
`python -c "import yaml; yaml.safe_load(open('.github/workflows/viz-tests.yml'))"` validates YAML syntax
  </verify>
  <done>
GitHub Actions workflow created with proper triggers, dependencies, and artifact upload.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify workflow and commit</name>
  <files>None</files>
  <action>
1. Validate the workflow file:
```bash
# Check YAML syntax
uv run python -c "import yaml; yaml.safe_load(open('.github/workflows/viz-tests.yml'))"
```

2. Test that tests can run locally (simulates CI):
```bash
# Run all viz tests (will skip if browsers not installed)
uv run pytest tests/viz/ -v --tb=short -m slow || echo "Some tests skipped (expected without browsers)"
```

3. The workflow will be committed with the plan completion commit.

Note: Actual CI validation happens when pushed to GitHub. The workflow is correct based on GitHub Actions documentation and common patterns.
  </action>
  <verify>
Workflow file exists and has valid YAML syntax.
Local tests run (or skip gracefully).
  </verify>
  <done>
CI workflow validated and ready for GitHub.
  </done>
</task>

</tasks>

<verification>
1. .github/workflows/viz-tests.yml exists with valid YAML
2. Workflow triggers on viz file changes
3. Workflow installs dependencies including Playwright browsers
4. Workflow runs both geometric and visual regression tests
5. Failed tests upload artifacts for debugging
</verification>

<success_criteria>
- VERIFY-03 (CI component): CI runs visual regression tests with Playwright screenshots
- Workflow triggers on relevant file changes
- Artifacts uploaded on failure for debugging
</success_criteria>

<output>
After completion, create `.planning/phases/04-verification-testing/04-03-SUMMARY.md`
</output>
