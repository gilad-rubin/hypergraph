---
phase: 04-verification-testing
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - tests/viz/test_visual_regression.py
  - tests/viz/baselines/.gitkeep
autonomous: false

must_haves:
  truths:
    - "Screenshot comparison detects visual changes in graph rendering"
    - "Baseline images can be created on first run"
    - "Threshold allows minor anti-aliasing differences"
  artifacts:
    - path: "tests/viz/test_visual_regression.py"
      provides: "Visual regression tests with screenshot comparison"
      min_lines: 50
  key_links:
    - from: "tests/viz/test_visual_regression.py"
      to: "tests/viz/conftest.py"
      via: "page_with_graph fixture"
      pattern: "page_with_graph"
---

<objective>
Create visual regression tests using Playwright screenshot comparison.

Purpose: Catch unintended visual changes to graph rendering beyond geometric correctness.
Output: Screenshot-based tests that compare against baseline images with tolerance for minor differences.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-verification-testing/04-RESEARCH.md
@.planning/phases/04-verification-testing/04-01-PLAN.md

# Fixtures from prior plan
@tests/viz/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create visual regression test module</name>
  <files>tests/viz/test_visual_regression.py, tests/viz/baselines/.gitkeep</files>
  <action>
1. Create tests/viz/baselines/ directory with .gitkeep file

2. Create tests/viz/test_visual_regression.py with:

```python
"""Visual regression tests using Playwright screenshots."""

import pytest
from pathlib import Path

BASELINES_DIR = Path(__file__).parent / "baselines"


def compare_screenshots(actual: bytes, baseline_path: Path, threshold: float = 0.1) -> tuple[bool, str]:
    """Compare screenshot to baseline with pixel difference threshold.

    Args:
        actual: Screenshot bytes from Playwright
        baseline_path: Path to baseline PNG
        threshold: Maximum allowed difference ratio (0.0-1.0)

    Returns:
        (passed, message) tuple
    """
    if not baseline_path.exists():
        # First run - create baseline
        baseline_path.parent.mkdir(parents=True, exist_ok=True)
        baseline_path.write_bytes(actual)
        return True, f"Created baseline: {baseline_path.name}"

    # Compare using Pillow
    from PIL import Image
    import io

    actual_img = Image.open(io.BytesIO(actual))
    baseline_img = Image.open(baseline_path)

    if actual_img.size != baseline_img.size:
        return False, f"Size mismatch: {actual_img.size} vs {baseline_img.size}"

    # Calculate pixel difference
    diff_count = 0
    total_pixels = actual_img.width * actual_img.height

    actual_data = actual_img.getdata()
    baseline_data = baseline_img.getdata()

    for actual_px, baseline_px in zip(actual_data, baseline_data):
        if actual_px != baseline_px:
            diff_count += 1

    diff_ratio = diff_count / total_pixels

    if diff_ratio > threshold:
        return False, f"Difference {diff_ratio:.2%} exceeds threshold {threshold:.2%}"

    return True, f"Match within threshold ({diff_ratio:.2%} difference)"


@pytest.mark.slow
class TestVisualRegression:
    """Visual regression tests for graph rendering."""

    def test_complex_rag_visual(self, page_with_graph, complex_rag_graph):
        """Visual regression test for complex_rag graph."""
        page = page_with_graph(complex_rag_graph)
        screenshot = page.screenshot(full_page=True)

        baseline = BASELINES_DIR / "complex_rag.png"
        passed, msg = compare_screenshots(screenshot, baseline)
        assert passed, msg

    def test_nested_collapsed_visual(self, page_with_graph, nested_graph):
        """Visual regression test for collapsed nested graph."""
        page = page_with_graph(nested_graph)
        screenshot = page.screenshot(full_page=True)

        baseline = BASELINES_DIR / "nested_collapsed.png"
        passed, msg = compare_screenshots(screenshot, baseline)
        assert passed, msg

    def test_double_nested_visual(self, page_with_graph, double_nested_graph):
        """Visual regression test for double-nested graph."""
        page = page_with_graph(double_nested_graph)
        screenshot = page.screenshot(full_page=True)

        baseline = BASELINES_DIR / "double_nested.png"
        passed, msg = compare_screenshots(screenshot, baseline)
        assert passed, msg
```

Note: Pillow is a transitive dependency of playwright - no need to add explicitly.
  </action>
  <verify>
`ls tests/viz/baselines/.gitkeep` exists
`uv run python -c "from tests.viz.test_visual_regression import compare_screenshots"` succeeds
  </verify>
  <done>
Visual regression test module created with compare_screenshots helper and 3 test cases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate baseline screenshots</name>
  <files>tests/viz/baselines/complex_rag.png, tests/viz/baselines/nested_collapsed.png, tests/viz/baselines/double_nested.png</files>
  <action>
Run the visual regression tests to generate baseline screenshots:

```bash
# Ensure playwright browsers are installed
uv run playwright install chromium

# Run visual tests to create baselines
uv run pytest tests/viz/test_visual_regression.py -v --no-header
```

The first run will create baseline images in tests/viz/baselines/:
- complex_rag.png
- nested_collapsed.png
- double_nested.png

Verify baselines are reasonable:
- Files exist and have non-zero size
- Can be opened as valid PNG images

Note: These baselines will be generated on the current machine. CI may need to regenerate on first run.
  </action>
  <verify>
`ls -la tests/viz/baselines/*.png` shows 3 PNG files with sizes > 10KB
`file tests/viz/baselines/*.png` confirms they are valid PNG images
  </verify>
  <done>
Baseline screenshots generated for all 3 test graphs.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Visual regression tests with baseline screenshots for complex_rag, nested_collapsed, and double_nested graphs</what-built>
  <how-to-verify>
1. Open the baseline images in tests/viz/baselines/:
   - complex_rag.png - Should show the 19-node RAG pipeline
   - nested_collapsed.png - Should show graph with collapsed nested subgraph
   - double_nested.png - Should show graph with two levels of nesting

2. Verify each image:
   - Graphs are visible and properly laid out
   - Edges connect nodes cleanly without crossing other nodes
   - Text is readable, nodes are properly styled

3. Run tests again to verify they pass against baselines:
   `uv run pytest tests/viz/test_visual_regression.py -v`
  </how-to-verify>
  <resume-signal>Type "approved" if baselines look correct, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. tests/viz/baselines/ contains 3 PNG baseline images
2. `uv run pytest tests/viz/test_visual_regression.py -v` all tests pass
3. Modifying edge routing causes visual regression test to fail (detects changes)
</verification>

<success_criteria>
- VERIFY-03: Visual regression tests with screenshot comparison implemented
- Baselines captured for complex_rag, nested_collapsed, double_nested graphs
- Tests detect visual changes with configurable threshold
</success_criteria>

<output>
After completion, create `.planning/phases/04-verification-testing/04-02-SUMMARY.md`
</output>
