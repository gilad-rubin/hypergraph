---
phase: 04-verification-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - tests/viz/conftest.py
  - tests/viz/test_edge_routing.py
autonomous: true

must_haves:
  truths:
    - "Test can render a graph to HTML and extract node positions"
    - "Test can extract edge path points from rendered SVG"
    - "Test can detect when an edge crosses a node"
  artifacts:
    - path: "tests/viz/test_edge_routing.py"
      provides: "Geometric verification tests"
      min_lines: 100
    - path: "tests/viz/conftest.py"
      provides: "Complex RAG fixture and Playwright helpers"
      contains: "complex_rag_graph"
  key_links:
    - from: "tests/viz/conftest.py"
      to: "hypergraph.viz.html_generator"
      via: "generate_widget_html import"
      pattern: "from hypergraph\\.viz.*import.*generate_widget_html"
    - from: "tests/viz/test_edge_routing.py"
      to: "shapely"
      via: "geometric intersection"
      pattern: "from shapely"
---

<objective>
Create geometric verification tests for edge routing using Playwright and Shapely.

Purpose: Automatically detect edge-over-node violations that manual visual inspection might miss.
Output: Working test suite that extracts coordinates from rendered graphs and verifies edges avoid nodes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-verification-testing/04-RESEARCH.md

# Prior phase context
@.planning/phases/03-unify-edge-routing/03-02-SUMMARY.md

# Key viz files
@src/hypergraph/viz/html_generator.py
@tests/viz/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add test dependencies and complex_rag fixture</name>
  <files>pyproject.toml, tests/viz/conftest.py</files>
  <action>
1. Add shapely to dev dependencies in pyproject.toml:
   ```
   uv add --dev shapely
   ```

2. Add complex_rag_graph fixture to conftest.py based on test_viz_layout.ipynb:
   - Create all 19 node functions (load_data through postprocess)
   - Create Graph fixture that matches the notebook's complex_rag
   - Add serve_graph_html factory fixture that:
     - Takes a Graph
     - Calls graph.to_viz_graph() then render_graph() then generate_widget_html()
     - Writes HTML to tmp_path and returns path

3. Add page_with_graph fixture that:
   - Takes a Graph via factory pattern
   - Navigates Playwright page to rendered HTML file
   - Waits for .react-flow__node selector
   - Waits for non-zero positions (layout completion)
   - Returns the page object

Note: pytest-playwright provides the `page` fixture automatically.
  </action>
  <verify>
Run `uv sync` to install shapely.
Run `uv run pytest tests/viz/conftest.py --collect-only` - should show fixtures.
  </verify>
  <done>
shapely in dev dependencies, complex_rag_graph fixture defined, serve_graph_html and page_with_graph fixtures ready for use.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create coordinate extraction helper</name>
  <files>tests/viz/test_edge_routing.py</files>
  <action>
Create tests/viz/test_edge_routing.py with:

1. extract_coordinates_from_page(page) function that uses page.evaluate() to run JavaScript:
   ```python
   def extract_coordinates_from_page(page) -> dict:
       """Extract node boxes and edge paths from rendered React Flow."""
       return page.evaluate("""() => {
           const nodes = {};
           const edges = {};

           // Extract node bounding boxes (absolute viewport coords)
           document.querySelectorAll('.react-flow__node').forEach(node => {
               const id = node.dataset.id;
               const rect = node.getBoundingClientRect();
               nodes[id] = {
                   left: rect.left,
                   top: rect.top,
                   right: rect.right,
                   bottom: rect.bottom
               };
           });

           // Extract edge paths by sampling SVG path
           document.querySelectorAll('.react-flow__edge').forEach(edge => {
               const id = edge.dataset.id;
               const path = edge.querySelector('path');
               if (!path) return;

               const length = path.getTotalLength();
               const points = [];
               for (let i = 0; i <= 50; i++) {
                   const pt = path.getPointAtLength((i / 50) * length);
                   points.push([pt.x, pt.y]);
               }
               edges[id] = points;
           });

           return { nodes, edges };
       }""")
   ```

2. verify_no_edge_node_intersections(coords) function using Shapely:
   - Convert node dicts to shapely.box() geometries
   - Convert edge point lists to shapely.LineString
   - For each edge, check intersection with each node (skip source/target)
   - Return list of violation strings (empty = pass)
   - Expand boxes by 0.75px for stroke width (1.5px stroke = 0.75px half-width)
  </action>
  <verify>
Import test file: `uv run python -c "from tests.viz.test_edge_routing import extract_coordinates_from_page, verify_no_edge_node_intersections"`
  </verify>
  <done>
Coordinate extraction and geometric verification helpers implemented with Shapely intersection testing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement geometric verification tests</name>
  <files>tests/viz/test_edge_routing.py</files>
  <action>
Add test functions to test_edge_routing.py:

1. test_complex_rag_no_edge_node_intersections:
   - Use page_with_graph fixture with complex_rag_graph
   - Extract coordinates
   - Call verify_no_edge_node_intersections
   - Assert no violations

2. test_nested_collapsed_no_edge_node_intersections:
   - Use nested_graph fixture (already in conftest)
   - Same verification pattern

3. test_nested_expanded_no_edge_node_intersections:
   - Use nested_graph fixture
   - Expand the nested graph (click to toggle expansion)
   - Re-extract coordinates and verify

4. test_double_nested_no_edge_node_intersections:
   - Use double_nested_graph fixture
   - Verify in collapsed state

Add pytest marks:
- @pytest.mark.slow (these tests require browser)
- Skip if playwright browsers not installed (try/except on launch)

Note: Edge ID format is "source__target" in React Flow - parse to skip source/target nodes.
  </action>
  <verify>
Run the tests: `uv run pytest tests/viz/test_edge_routing.py -v --no-header`
All 4 tests should pass (or skip if browsers not installed).
  </verify>
  <done>
TEST-01 (complex_rag), TEST-02 (collapsed), TEST-03 (expanded), TEST-04 (double-nested) implemented as geometric verification tests.
  </done>
</task>

</tasks>

<verification>
1. `uv sync` succeeds with shapely installed
2. `uv run pytest tests/viz/test_edge_routing.py -v` runs all 4 tests
3. Tests detect edge-node intersections (can verify by temporarily breaking edge routing)
4. Tests skip gracefully if Playwright browsers not installed
</verification>

<success_criteria>
- VERIFY-01: extract_coordinates_from_page extracts node/edge coordinates
- VERIFY-02: verify_no_edge_node_intersections uses Shapely to detect violations
- TEST-01 through TEST-04: All 4 test cases implemented and passing
</success_criteria>

<output>
After completion, create `.planning/phases/04-verification-testing/04-01-SUMMARY.md`
</output>
