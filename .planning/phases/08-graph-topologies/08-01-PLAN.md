---
phase: 08-graph-topologies
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [tests/test_graph_topologies.py]
autonomous: true

must_haves:
  truths:
    - "Diamond dependency pattern (A->B, A->C, B->D, C->D) creates correct edges"
    - "Multi-node cycle (A->B->C->A) is detected as cyclic"
    - "Multi-node cycle computes correct seeds for all cycle parameters"
    - "Multiple independent cycles in one graph both detected"
    - "Isolated subgraphs (disconnected components) work correctly"
    - "Deeply nested graphs (3+ levels) work correctly"
  artifacts:
    - path: "tests/test_graph_topologies.py"
      provides: "Graph topology tests"
      contains: "class TestDiamondPattern"
  key_links:
    - from: "tests/test_graph_topologies.py"
      to: "src/hypergraph/graph.py"
      via: "test methods using Graph, has_cycles, inputs.seeds"
      pattern: "Graph\\(|has_cycles|inputs\\.seeds"
---

<objective>
Test complex graph topologies to verify the Graph class handles non-trivial structures correctly.

Purpose: Ensure diamond patterns, multi-node cycles, multiple cycles, disconnected components, and deeply nested graphs all work as expected.

Output: New test file `tests/test_graph_topologies.py` with comprehensive topology tests covering all 5 TOPO requirements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

Source files:
@src/hypergraph/graph.py
@tests/test_graph.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test file with diamond and multi-node cycle tests</name>
  <files>tests/test_graph_topologies.py</files>
  <action>
Create new test file `tests/test_graph_topologies.py` for topology tests.

**File structure:**

```python
"""Tests for complex graph topologies."""

import pytest
from hypergraph import InputSpec
from hypergraph.graph import Graph, GraphConfigError
from hypergraph.nodes.function import node
```

**Class 1: TestDiamondPattern (TOPO-01)**

Test the diamond dependency pattern: A->B, A->C, B->D, C->D

```
    A (produces 'a')
   / \
  B   C  (both consume 'a', produce 'b' and 'c')
   \ /
    D    (consumes both 'b' and 'c')
```

Tests to create:

1. **test_diamond_creates_correct_edges**
   - Create 4 nodes: A produces 'a', B consumes 'a' produces 'b', C consumes 'a' produces 'c', D consumes 'b' and 'c'
   - Assert graph has 4 edges: A->B, A->C, B->D, C->D
   - Assert `g.nx_graph.has_edge("node_a", "node_b")` etc.

2. **test_diamond_leaf_outputs**
   - Same diamond graph
   - Assert `g.leaf_outputs` contains only D's output (not A, B, C)

3. **test_diamond_inputs**
   - Diamond where A takes external input 'x'
   - Assert `g.inputs.required` contains only 'x' (all others are internal)

4. **test_diamond_is_dag**
   - Assert `g.has_cycles` is False (diamond is acyclic)

**Class 2: TestMultiNodeCycle (TOPO-02)**

Test multi-node cycles: A->B->C->A

```
    A (produces 'a', consumes 'c')
    |
    v
    B (produces 'b', consumes 'a')
    |
    v
    C (produces 'c', consumes 'b')
    |
    +---> back to A
```

Tests to create:

1. **test_three_node_cycle_detected**
   - Create 3 nodes forming cycle: A produces 'a' consumes 'c', B produces 'b' consumes 'a', C produces 'c' consumes 'b'
   - Assert `g.has_cycles` is True

2. **test_three_node_cycle_seeds**
   - Same 3-node cycle
   - Assert `g.inputs.seeds` contains all cycle parameters ('a', 'b', 'c')
   - Or just one seed if only one entry point needed (check actual behavior)

3. **test_three_node_cycle_no_required_inputs**
   - If all inputs are from cycle, required should be empty
   - Assert `g.inputs.required == ()` (unless there's an external input)

4. **test_cycle_with_external_input**
   - 3-node cycle where A also takes external input 'x'
   - Assert 'x' is in `g.inputs.required`
   - Assert cycle params are in `g.inputs.seeds`
  </action>
  <verify>uv run pytest tests/test_graph_topologies.py -v</verify>
  <done>
- test_graph_topologies.py exists with TestDiamondPattern and TestMultiNodeCycle classes
- Diamond tests verify correct edges, leaf outputs, inputs, and DAG status
- Multi-node cycle tests verify cycle detection and seed computation
- All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for multiple cycles, isolated subgraphs, and nested graphs</name>
  <files>tests/test_graph_topologies.py</files>
  <action>
Add remaining topology test classes to tests/test_graph_topologies.py.

**Class 3: TestMultipleCycles (TOPO-03)**

Test graphs with multiple independent cycles.

```
Graph with two separate cycles:
  Cycle 1: X -> Y -> X (self-reinforcing)
  Cycle 2: P -> Q -> R -> P (separate 3-node cycle)
```

Tests:

1. **test_two_independent_cycles_detected**
   - Create graph with two separate cycles that don't interact
   - Assert `g.has_cycles` is True

2. **test_two_independent_cycles_seeds**
   - Assert seeds from both cycles are detected
   - Check that seeds include parameters from both cycles

3. **test_cycles_with_shared_external_input**
   - Two cycles, but both consume same external input 'config'
   - Assert 'config' is in required, cycle params are in seeds

**Class 4: TestIsolatedSubgraphs (TOPO-04)**

Test disconnected components (no edges between them).

```
Component 1: A -> B
Component 2: X -> Y (completely separate)
```

Tests:

1. **test_disconnected_components_both_work**
   - Create graph with two unconnected chains: A->B and X->Y
   - Assert both are in `g.nodes`
   - Assert `g.outputs` includes outputs from both

2. **test_disconnected_components_separate_inputs**
   - A needs 'a', X needs 'x' (different inputs)
   - Assert `g.inputs.required` contains both 'a' and 'x'

3. **test_disconnected_components_no_cross_edges**
   - Assert no edge exists between components
   - Check edge count equals sum of internal edges

4. **test_disconnected_all_are_leaves**
   - If neither component feeds the other, all terminal nodes are leaves
   - Assert `g.leaf_outputs` contains outputs from both chains' end nodes

**Class 5: TestDeeplyNestedGraphs (TOPO-05)**

Test graphs nested 3+ levels deep using GraphNode.

```
Level 3: inner_inner_graph (single node)
Level 2: inner_graph (contains inner_inner as GraphNode)
Level 1: outer_graph (contains inner as GraphNode)
```

Tests:

1. **test_three_level_nesting_works**
   - Create innermost graph with one node
   - Wrap as GraphNode, put in middle graph
   - Wrap middle as GraphNode, put in outer graph
   - Assert outer graph constructs without error

2. **test_three_level_inputs_propagate**
   - Innermost takes 'x', middle adds 'y', outer adds 'z'
   - Assert outer graph's inputs include 'x', 'y', 'z'

3. **test_three_level_outputs_visible**
   - Each level produces an output
   - Assert outer graph's outputs include all three

4. **test_nested_with_strict_types**
   - Same 3-level nesting with strict_types=True
   - Ensure types flow correctly through all levels
   - Assert no GraphConfigError raised

5. **test_deeply_nested_definition_hash**
   - Verify definition_hash is computed for deeply nested graph
   - Assert hash is deterministic (same structure = same hash)
  </action>
  <verify>uv run pytest tests/test_graph_topologies.py -v</verify>
  <done>
- TestMultipleCycles class with 3 tests for multiple independent cycles
- TestIsolatedSubgraphs class with 4 tests for disconnected components
- TestDeeplyNestedGraphs class with 5 tests for 3+ level nesting
- All tests pass
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `uv run pytest tests/test_graph_topologies.py -v` runs all tests (15+ tests)
- [ ] No syntax errors in test file
- [ ] Test file follows existing patterns from test_graph.py
- [ ] Tests cover all 5 TOPO requirements
- [ ] Each test has clear docstring explaining what it verifies
</verification>

<success_criteria>

- test_graph_topologies.py exists with 5 test classes
- TestDiamondPattern: 4 tests for TOPO-01
- TestMultiNodeCycle: 4 tests for TOPO-02
- TestMultipleCycles: 3 tests for TOPO-03
- TestIsolatedSubgraphs: 4 tests for TOPO-04
- TestDeeplyNestedGraphs: 5 tests for TOPO-05
- All 20 tests pass
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/08-graph-topologies/08-01-SUMMARY.md`
</output>
