---
phase: 03-fix-edge-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hypergraph/viz/assets/layout.js
autonomous: true

must_haves:
  truths:
    - "Coordinate transformations are explicit named functions, not inline arithmetic"
    - "Absolute positions tracked separately from React Flow parent-relative positions"
    - "All nodes have calculable absolute viewport positions regardless of nesting depth"
  artifacts:
    - path: "src/hypergraph/viz/assets/layout.js"
      provides: "CoordinateTransform object with named transformation functions"
      contains: "CoordinateTransform"
  key_links:
    - from: "performRecursiveLayout"
      to: "CoordinateTransform"
      via: "function calls for position calculations"
      pattern: "CoordinateTransform\\."
---

<objective>
Create explicit coordinate transformation functions in layout.js to eliminate inline arithmetic and enable correct edge routing in nested graphs.

Purpose: The research identified coordinate space confusion as the root cause of edge routing bugs. This plan establishes the foundation by creating named transformation functions and tracking absolute positions for all nodes.

Output: CoordinateTransform object with transformation functions, absolute position tracking in performRecursiveLayout.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-fix-edge-routing/03-RESEARCH.md

# Prior phase summaries
@.planning/phases/02-unify-edge-routing/02-01-SUMMARY.md
@.planning/phases/02-unify-edge-routing/02-02-SUMMARY.md

# Key source files
@src/hypergraph/viz/assets/layout.js
@src/hypergraph/viz/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CoordinateTransform object with named transformation functions</name>
  <files>src/hypergraph/viz/assets/layout.js</files>
  <action>
Add a CoordinateTransform object near the top of the module (after the constants section) with the following transformation functions:

```javascript
// === COORDINATE TRANSFORMATIONS ===
// Explicit functions to convert between coordinate spaces:
// - Layout Space: Centers with LAYOUT_PADDING (50px), used by constraint solver
// - Parent-Relative Space: Top-left relative to parent, used by React Flow
// - Absolute Viewport Space: Top-left relative to viewport, used for edge routing

var LAYOUT_PADDING = 50;  // constraint-layout.js internal padding

var CoordinateTransform = {
  // Layout space (centers) -> Parent-relative space (top-left)
  // Used when converting constraint layout results for React Flow
  layoutToParentRelative: function(layoutNode, layoutPadding, graphPadding) {
    return {
      x: layoutNode.x - layoutNode.width / 2 - layoutPadding + graphPadding,
      y: layoutNode.y - layoutNode.height / 2 - layoutPadding + graphPadding
    };
  },

  // Parent-relative space -> Absolute viewport space
  // Used when calculating edge routing positions for nested nodes
  parentRelativeToAbsolute: function(childPos, parentAbsPos, headerHeight, graphPadding) {
    return {
      x: parentAbsPos.x + childPos.x + graphPadding,
      y: parentAbsPos.y + childPos.y + headerHeight + graphPadding
    };
  },

  // Get absolute position of any node (handles arbitrary nesting depth)
  // Recursively walks parent chain to compute viewport-space position
  getAbsolutePosition: function(nodeId, nodePositions, parentNodeMap) {
    var pos = nodePositions.get(nodeId);
    if (!pos) return { x: 0, y: 0 };

    var node = parentNodeMap.get(nodeId);
    if (!node || !node.parentNode) {
      // Root node - position is already absolute
      return { x: pos.x, y: pos.y };
    }

    // Recursively get parent's absolute position and add relative offset
    var parentAbsPos = this.getAbsolutePosition(node.parentNode, nodePositions, parentNodeMap);
    return {
      x: parentAbsPos.x + pos.x,
      y: parentAbsPos.y + pos.y
    };
  }
};
```

This creates explicit, testable transformation functions instead of scattered inline arithmetic like `n.x - w/2 - layoutPadding + graphPadding`.
  </action>
  <verify>
Run: `grep -n "CoordinateTransform" src/hypergraph/viz/assets/layout.js`
Should show the object definition and all three functions.
  </verify>
  <done>
CoordinateTransform object exists with layoutToParentRelative, parentRelativeToAbsolute, and getAbsolutePosition functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Track absolute positions in performRecursiveLayout</name>
  <files>src/hypergraph/viz/assets/layout.js</files>
  <action>
Update performRecursiveLayout to use CoordinateTransform and track absolute positions for edge routing.

1. Add absolutePositions Map at the start of the function (alongside nodeDimensions, childLayoutResults):
```javascript
var absolutePositions = new Map();  // Node ID -> {x, y} in viewport space
```

2. Create a parentNodeMap for getAbsolutePosition lookups:
```javascript
var parentNodeMap = new Map(visibleNodes.map(function(n) { return [n.id, n]; }));
```

3. When positioning root nodes (in the "Position root nodes" section), store absolute positions:
```javascript
// Root nodes: position is already absolute (top-left of viewport content area)
rootResult.nodes.forEach(function(n) {
  var w = n.width;
  var h = n.height;
  var x = n.x - w / 2;  // Layout uses centers, convert to top-left
  var y = n.y - h / 2;
  nodePositions.set(n.id, { x: x, y: y });
  absolutePositions.set(n.id, { x: x, y: y });  // ADD THIS LINE
  // ... rest of existing code
});
```

4. When positioning children (in the "Position children within their parents" section), use CoordinateTransform:
```javascript
childResult.nodes.forEach(function(n) {
  var w = n.width;
  var h = n.height;
  // Use CoordinateTransform instead of inline arithmetic
  var relativePos = CoordinateTransform.layoutToParentRelative(
    { x: n.x, y: n.y, width: w, height: h },
    layoutPadding,
    GRAPH_PADDING
  );
  var childX = relativePos.x;
  var childY = relativePos.y;

  // Calculate and store absolute position for edge routing
  var parentAbsPos = absolutePositions.get(graphNode.id);
  var absPos = CoordinateTransform.parentRelativeToAbsolute(
    { x: childX, y: childY + HEADER_HEIGHT },
    parentAbsPos,
    0,  // headerHeight already included in childY
    0   // graphPadding already included in childX/childY
  );
  absolutePositions.set(n.id, absPos);

  // Store parent-relative position for React Flow
  nodePositions.set(n.id, { x: absOffsetX + childX, y: absOffsetY + childY });
  // ... rest of existing code unchanged
});
```

5. Store absolutePositions in the return object (or attach to a module-level variable for edge routing to access):
```javascript
return {
  nodes: allPositionedNodes,
  edges: resolvedEdges,
  size: rootResult.size,
  absolutePositions: absolutePositions  // ADD THIS
};
```

The key insight: Edge routing needs viewport-space coordinates, but React Flow rendering needs parent-relative coordinates. Track both.
  </action>
  <verify>
Run: `grep -n "absolutePositions" src/hypergraph/viz/assets/layout.js`
Should show the Map creation, population for root nodes, population for child nodes, and return statement.

Run: `grep -n "CoordinateTransform\." src/hypergraph/viz/assets/layout.js`
Should show calls to layoutToParentRelative and parentRelativeToAbsolute.
  </verify>
  <done>
performRecursiveLayout tracks absolute positions for all nodes and returns absolutePositions Map in its result.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify existing tests still pass</name>
  <files>tests/viz/test_renderer.py</files>
  <action>
Run the existing viz tests to ensure the coordinate transformation changes don't break current behavior:

```bash
uv run pytest tests/viz/test_renderer.py -v
```

The changes should be purely additive - we're adding new functions and tracking additional data, not changing the existing React Flow positions.

If any tests fail, investigate whether the failure is:
1. A test that explicitly checks coordinate values (may need adjustment for new precision)
2. A regression in the actual behavior (fix the implementation)

Expected: All tests pass because we haven't changed the React Flow positions, only added absolute position tracking.
  </action>
  <verify>
`uv run pytest tests/viz/test_renderer.py -v` shows all tests passing
  </verify>
  <done>
All existing viz tests pass, confirming the changes are backward-compatible.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. CoordinateTransform object exists with three named transformation functions
2. performRecursiveLayout returns absolutePositions Map
3. All existing tests pass
4. No inline coordinate arithmetic like `n.x - w/2 - layoutPadding + graphPadding` in new code
</verification>

<success_criteria>
- CoordinateTransform object with layoutToParentRelative, parentRelativeToAbsolute, getAbsolutePosition
- absolutePositions Map tracked and returned from performRecursiveLayout
- Existing viz tests pass (no regression)
- Foundation ready for Plan 02 to fix edge routing algorithm
</success_criteria>

<output>
After completion, create `.planning/phases/03-fix-edge-routing/03-01-SUMMARY.md`
</output>
